% !TEX TS-program = lualatex
\documentclass[12pt]{article}

% This entire package is placed under the terms of the
% LaTeX Project Public License, version 1.3 or later
% (http://www.latex-project.org/lppl.txt).
% It has the status "maintained".
%
% Author: Mico Loretan (loretan dot mico at gmail dot com)
% Date: 2012/12/26

% Check first that we're running lua(la)tex.
\usepackage{ifluatex}
\ifluatex\else
  \typeout{ =========================================}
  \typeout{ The file selnolig.tex must be compiled   }
  \typeout{ using LuaLaTeX. Exiting immediately.     }
  \typeout{ =========================================}
  \endinput
\fi

\usepackage{fontspec}
\setmainfont[ Numbers = OldStyle,
    Ligatures  = {TeX, Common, Discretionary},
    ItalicFont = {Garamond Premier Pro Italic} ]
    {Garamond Premier Pro}

\setsansfont[Scale=MatchLowercase]{HelveticaNeue}
\setmonofont[Scale=MatchLowercase]{Consolas}

\newfontfamily\blackletterfont[Ligatures = NoCommon]
    {UnifrakturMaguntia}

\newfontfamily\ebg[ Numbers = OldStyle,
    Ligatures  = {TeX, Common, Discretionary, Historic},
    ItalicFont = {EB Garamond 12 Italic}]
    {EB Garamond 12 Regular}

\usepackage{geometry}
\usepackage[english=american]{csquotes}
\usepackage[ngerman,english]{babel}
\hyphenation{ver-werf-lich}

\usepackage[all]{selnolig}

% Suppress st-ligature in some German words
%    that occur in this document
\nolig{Kunststo}{Kuns|ts|to} % Kunststoff
\nolig{Bausto}{Baus|to}      % Baustoff
\nolig{streif}{s|treif}      % streifte
\nolig{instru}{ins|tru}      % Zupfinstrument
\nolig{justiz}{jus|tiz}      % Strafjustiz
\nolig{Konstanz}{Kons|tanz}	
\nolig{Institut}{Ins|titut}



\usepackage{microtype}
\usepackage{multicol}

\usepackage{metalogo} % for LuaLaTeX and XeLaTeX logos
  \makeatletter
  \def\xl@drop@TeX@e{0.35ex}    % default:  0.5ex
  \def\xl@drop@Xe@e{0.35ex}     % default:  0.5ex
  \def\xl@kern@La@La{-.33em}    % default: -0.36ex
  \def\xl@kern@LaTeX@aT{-.16em} % default: -0.15ex
  \makeatother

\usepackage{sectsty}
\allsectionsfont{\mdseries}

\usepackage{tocloft}
\cftsetindents{sec}{0em}{2em}
\cftsetindents{subsec}{2em}{2.25em}
\cftsetindents{subsubsec}{4.25em}{3em}
\renewcommand{\cfttoctitlefont}{\large}
\renewcommand{\cftsecfont}{\mdseries}
\renewcommand{\cftsecpagefont}{\mdseries}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}

\usepackage{needspace}
\usepackage{fancyvrb}
\DefineShortVerb{\|}

\clubpenalty10000
\widowpenalty10000

\usepackage[bottom,splitrule]{footmisc}

\usepackage[svgnames]{xcolor}
\usepackage[colorlinks=true,linktocpage,
   allcolors=DarkBlue]{hyperref}
\usepackage[capitalize,nameinlink,noabbrev]{cleveref}

% some frequently-used commands
\newcommand{\pkg}[1]{\textsf{#1}}
\newcommand{\opt}[1]{\texttt{#1}}
\newcommand{\cmmd}[1]{\texttt{\textbackslash #1}}

\let\oldappendix\appendix
\renewcommand\appendix{%
   \clearpage
   \addtocontents{toc}{\protect{\vspace{0.75\baselineskip}}}
   \addtocontents{toc}{\protect{\mdseries Appendices\par}}
   \noindent
   {\Large Appendices}
   \oldappendix}

\frenchspacing
\clubpenalty10000
\widowpenalty10000

% The macros \selnoligpackagename, 
% \selnoligpackageversion, and 
% \selnoligpackagedate used in '\title' and 
% '\date' below are defined in 'selnolig.sty'.

\title{The \selnoligpackagename\ package: \\
Selective suppression of typographic ligatures\thanks{
Current version: \selnoligpackageversion. Features of the \pkg{selnolig} package are subject to change without prior notice. 
\newline\hspace*{\parindent}
The main text fonts used in this document are \enquote{Garamond Premier Pro} (for the most part) and \enquote{EB Garamond} (for the passages involving the \bgroup\ebg \mbox{fb}, \mbox{fh}, \mbox{fk}, \mbox{ffb}, \mbox{ffh},  \mbox{ffk}, and \emph{\mbox{sk}} ligatures\egroup). Both \enquote{common} and \enquote{discretionary} typographic ligatures are enabled for these two fonts\textemdash \emph{and} suppressed selectively using \pkg{selnolig}'s macros.}}
\author{Mico Loretan\thanks{
\href{mailto:loretan.mico@gmail.com}{loretan dot mico at gmail dot com}.}}
\date{\selnoligpackagedate}

\renewcommand\abstractname{Summary}

\begin{document}
\VerbatimFootnotes
\pagenumbering{roman}

\maketitle


\begin{abstract}

The \pkg{selnolig} package lets users suppress typographic ligatures based on pre\-defined search patterns. The search patterns focus on ligatures deemed inappropriate because they span morpheme boundaries. For example, the word \opt{shelfful}, which is mentioned in the \TeX book as a word for which the \enquote{ff} ligature might be inappropriate, is automatically typeset as shelfful rather than as shel\mbox{ff}ul.
\newline\hspace*{\parindent}
For English and German language documents, the \pkg{selnolig} package provides ligature suppression macros  for the \enquote{common} f-ligatures. These comprise not only the familiar~ff, fi, fl, ffi, and~ffl ligatures but also the \char"E18D\ and~\char"E187\ ligatures.
\newline\hspace*{\parindent}
For English language documents, the package further provides ligature suppression macros for a number of so-called \enquote{discretionary} and \enquote{historic} ligatures.
\newline\hspace*{\parindent}
The \pkg{selnolig} package requires the \LuaLaTeX\ format provided by a reasonably modern \TeX\ distribution such as \TeX Live\,2012, Mac\TeX\,2012, or MiK\TeX\,2.9.
\end{abstract}

\tocloftpagestyle{empty}

\enlargethispage{0.8\baselineskip}
\tableofcontents

\clearpage
\pagenumbering{arabic}
\section{Introduction}

The ability of \TeX\ and Friends to use typographic ligatures has long been cherished by its users. Indeed, the automated and transparent use of typographic ligatures by \TeX\ and Friends is often offered up as one of the reasons for using these programs to obtain high-quality typeset output.

However, even though the automatic use of typographic ligatures is highly desirable in general, there are words for which the use of certain typographic ligatures may not be appropriate. The \TeX book observes, on p.~19, that the word \enquote{\mbox{shelfful}} may look better if it is typeset as \enquote{shelfful}, i.e., \emph{without} the ff-ligature. Some other English-language words that would generally be considered to be good candidates for non-use of ligatures are \mbox{cufflink} and \mbox{offload}; compare their appearance with that of cufflink and offload. Observe that all of these words are composite: the first word component (or morpheme) ends in an~\enquote{f\,} or~\enquote{ff\,}, and the second component (morpheme) beginning with either an~\enquote{f\,} (in the case of shelfful) or an~\enquote{l} (in the cases of cufflink and offload). A morpheme, briefly stated, is the smallest linguistic unit within a word that bears distinct meaning. Thus, the words shelfful and offload each contain two morphemes. 

On the whole, though, the need to suppress typographic ligatures selectively for English language documents  generally does not appear to be an enormously pressing concern, possibly because English doesn't feature composite words that frequently. However, in other languages, such as German, composite words are much more common; in these languages, there is naturally a much greater potential for composite words to feature f-f, f-l, and f-i (and other such character pairs and triples) across morpheme boundaries. In German typography, the use of ligatures across morpheme boundaries is considered something to be avoided at (nearly) all cost, probably because ligatures that span morphemes have the potential to impair seriously the intelligibility of these words.\footnote{For German texts, I believe that the \emph{Duden} provides authoritative backing for questions related to selective ligature suppression. For English texts, I'm actually not aware of a document issued by an official or quasi-official body that discourages the use of typographic ligatures across morpheme boundaries. If anybody can provide such a reference, I would be happy to list it.} Words such as \mbox{elffach} and \mbox{kopflos}  (containing ff- and fl-ligatures) simply look wrong to a German reader; they should be typeset as elffach and kopflos, respectively.

\TeX\ and Friends offer several methods for suppressing ligatures on a case-by-case basis.\footnote{In \LaTeX, there are three basic methods for suppressing ligature within a character pair: (i)~insertion of an \enquote{empty atom}, |{}| between the characters, (ii)~insertion of an explicit italic correction, |\/|, and (iii)~insertion of an explicit \enquote{kern}, e.g., |\kern0pt| or \Verb/\hspace{0pt}/. The \pkg{babel} package, when used with the \opt{ngerman} option, offers the \enquote{shortcut} macro \Verb/"|/ for this purpose. Note, though, that the first ligature suppression method, \Verb/{}/, does \emph{not} work if the document is compiled with \LuaLaTeX.} However, these methods must be applied separately to each and every occurrence of all words that contain undesirable ligatures. As such, these methods are both time-intensive and tedious, and there's a residual risk that some words for which ligatures should be suppressed will be overlooked in the editing process. 

What has \emph{not} been available so far is a \LaTeX\ package that (i) specifies a list of word patterns and entire words for which ligatures should be suppressed and (ii) systematically discovers all instances of these words in a document and applies the non-ligation rules automatically. The \pkg{selnolig} package is meant to address this need. The package is currently set up to handle English and German language non-ligation issues by providing extensive lists of ligature suppression macros appropriate for the respective languages. Of course, no claim as to the completeness of either list is made\textemdash or can be made. The package attempts to make it fairly easy for users to provide additional ligature suppression rules to treat words not already covered by the package.\footnote{If you discover such words, please email them to me so that I can augment and update the package's ligature suppression rules accordingly. A suggested template for reporting such cases is provided in \cref{sec:template}.} 

For both English and German language documents, the \pkg{selnolig} package provides macros to suppress selectively the following f-ligatures: ff, fi, fl, ffi, and ffl\textemdash the \enquote{standard} f-ligatures that should be familiar to most users of Computer Modern fonts\textemdash as well as the~ft (or~\char"E18D) and~\char"E187\ ligatures. The latter two ligatures, while not provided by the Computer Modern font family, are available frequently in \enquote{oldstyle} or \enquote{Garalde} font families.

For English language documents, the package's default setting is to suppress f-ligatures for only a fairly basic set of words. However, if the package's \opt{broadf} option is set, additional f-ligatures can be suppressed, e.g., for words that contain the {\ebg \mbox{fb}, \mbox{fh}, \mbox{fj}, and \mbox{fk}} character pairs. The package also features an option called \opt{hdlig}. If this option is set, the package will suppress selectively historic and discretionary ligatures, such as those for the ct, st, sp, {\ebg\emph{sk}}, \emph{th}, \emph{et}, and~\emph{as} character pairs. 


For German language documents, all instances of {\ebg \mbox{fb}, \mbox{fh}, \mbox{fj}, and~\mbox{fk}} ligatures are suppressed globally; see \cref{sec:global-nolig} for more details. However, exceptions are provided in order \emph{not} to suppress these ligatures for selected words of \emph{non-German} origin\textemdash such as fjord, fjell, Prokofjew, and {\ebg Kafka}. At this time, no macros for the selective suppression of historic and/or discretionary ligatures are provided for German language documents.

The \pkg{selnolig} package also provides additional hyphenation exception lists for both English and German language words. These words are generally composite and contain one more typographic ligatures that should be suppressed.

A remark on the classification of various forms of typographic ligatures: Among the ligature-rich OpenType fonts I'm familiar with that can be loaded via the commands of the \pkg{fontspec} package, there appears to a near-complete lack of terminological standardization as to which typographic ligatures\textemdash beyond the so-called \enquote{common} ligatures (mainly f-ligatures)\textemdash are labelled \enquote{historic} and which ones are labelled \enquote{discretionary}. The fonts Latin Modern Roman, Garamond Premier Pro, and Hoefler Text report having \enquote{only} discretionary ligatures, whereas Junicode, Cardo, EB Garamond, and Palatino Linotype report featuring both historic and discretionary ligatures. Interestingly, none of these fonts report having ligatures classified as either \enquote{contextual} or \enquote{required}. 
%The \pkg{selnolig} package provides the \opt{hdlig} option to enable ligature suppression rules that apply to ligatures that may be classified as either \enquote{historic} or \enquote{discretionary}.

\section{I'm in a hurry! How do I start using this package?}

\subsection[How do I load the selnolig package?]{How do I load the \pkg{selnolig} package?}

\begin{itemize}
\item If your document is in English and you want to suppress f-ligatures for a \enquote{basic} set of words and word patterns, you should load the package as follows:
\begin{Verbatim}
     \usepackage[english]{selnolig}
\end{Verbatim}
Synonymous options for \opt{english} are \opt{UKenglish}, \opt{british}, \opt{USenglish}, \opt{american}, \opt{cana\-dian}, \opt{australian}, and \opt{new\-zealand}.

\begin{itemize}
\item If you want to load a broader set of f-ligature suppression rules than the set that's enabled by default, be sure to also specify the \opt{broadf} option; see  \cref{sec:eng-opt}.

\item If the font you use for your document also provides \enquote{historic} and/or \enquote{discretionary} ligatures (e.g., ct, st, sp, \emph{th}, \emph{as}, \emph{is}, \emph{us}, etc.), you should also specify the \opt{hdlig} option (in addition to the \opt{english} option, of course) when loading the \pkg{selnolig} package.\footnote{If the \pkg{selnolig} package is loaded \emph{after} the \pkg{fontspec} package, a macro is run to inquire if historic and/or discretionary ligatures are enabled; if the answer is yes, the \opt{hdlig} option is enabled automatically.}
\end{itemize}
\item If your document is written in German, load the package as follows:
\begin{Verbatim}
     \usepackage[ngerman]{selnolig}
\end{Verbatim}
Synonymous options are \opt{german}, \opt{austrian}, \opt{naustrian},  \opt{swissgerman}, and \opt{swiss}.

\item If you load the package \emph{without} an explicit language option, i.e., as
\begin{Verbatim}
     \usepackage{selnolig}
\end{Verbatim}
but if one or more of the language options noted above are specified as options to the \cmmd{documentclass} instruction, \LaTeX\ will pass these options on to the \pkg{selnolig} package.

\item If no language options are set, either when the package is loaded or as options in the \cmmd{documentclass} instruction, loading the \pkg{selnolig} package will have no effect on the appearance of your document\textemdash unless you specify various \cmmd{nolig} macros on your own.
\end{itemize}


\subsection{Any hints on how to get started with \LuaLaTeX?}

The ligature suppression macros of the \pkg{selnolig} package \emph{require} the use of the \LuaLaTeX\ format. They will \emph{not} work with pdf\LaTeX\ or \XeLaTeX. One can load the \pkg{selnolig} package under either pdf\LaTeX\ or \XeLaTeX, but then only the package's hyphenation exception patterns will be loaded; the ligature suppression macros won't be loaded because they are based on lua code. If it's not run under \LuaLaTeX, the \pkg{selnolig} package will issue a warning message  to the effect that its ligature suppression macros won't be running, but it will not terminate prematurely.

The requirement to use \LuaLaTeX\ will likely force you to make some changes to the preambles of your existing \LaTeX\ documents. Fortunately, the required changes should be fairly minor and straightforward to implement because \LuaLaTeX\ is, for the most part, a strict superset of pdf\LaTeX. Almost all documents that compile correctly under pdf\LaTeX\ should also compile correctly under \LuaLaTeX\ as long as some relatively minor changes are made.
The two main required changes are: (i)~don't load the |inputenc| and |fontenc| packages, and (ii)~insert the instruction
\begin{Verbatim}
     \usepackage{fontspec}
\end{Verbatim}
in the preamble. If the \pkg{fontspec} package isn't loaded by the time the \Verb+\begin{document}+ statement is encountered, \pkg{selnolig} will terminate with an error message. It is recommended (but not required) that you load \pkg{selnolig} \emph{after} \pkg{fontspec} and the latter package's font- and ligature-related commands.

Of course, you'll also need to use a \TeX\ distribution that includes a fairly recent version of \LuaLaTeX. \TeX Live\,2012, Mac\TeX\,2012, and MiK\TeX\,2.9 all satisfy this requirement. The version of \LuaLaTeX\ distributed with TeXLive\,2011 is probably sufficiently recent to meet the package's requirements, but the version distributed with TeXLive\,2009 is almost certainly not. 

If you use a command-line interface to compile your document named, say, |myfile.tex|, be sure to type 
\begin{Verbatim}
     lualatex myfile
\end{Verbatim}
rather than |latex myfile| (or |pdflatex myfile|). If you use an editor with pull-down menus or buttons to invoke a suitable \TeX\ compiler for your document, be sure to select |LuaLaTeX|. 

The very first time one runs \LuaLaTeX\ on a document with a new set of fonts, the compilation speed will likely be quite slow because \LuaLaTeX\ has to build various cache files to store font-related information. Subsequent compilation runs should be much faster. 

Depending on your \TeX\ distribution, the default font family used by \LuaLaTeX\ will be either Computer Modern or Latin Modern. If you wish to use a different font family, further instructions will be required. How to specify fonts and font families and set up various font-related options in \LuaLaTeX\ are subjects that go far beyond the scope of this user guide. I urge you to become familiar with the \href{http://www.ctan.org/tex-archive/macros/latex/contrib/fontspec/fontspec.pdf}{user guide} of the \pkg{fontspec} package to learn how to set a multitude of font-related options.

The answers to the questions \href{http://tex.stackexchange.com/q/28642/5001}{Frequently loaded packages: Differences between pdf\LaTeX\ and \LuaLaTeX?} and \href{http://tex.stackexchange.com/q/32295/5001}{Using Lua\TeX\ as a replacement for pdf\TeX}, both posted to \href{http://tex.stackexchange.com/}{tex.stackexchange.com}, provide some very useful information for people who are reasonably familiar with pdf\LaTeX\ but are new to \LuaLaTeX. Another great resource for people who would like to become more familiar with \LuaLaTeX\ is  \href{http://mirror.ctan.org/info/luatex/lualatex-doc/lualatex-doc.pdf}{A Guide to \LuaLaTeX}, written by Manuel Pégourié-Gonnard.


\subsection{Anything else I need to do or know?} \label{sec:anythingelse}

For multilingual support, \LuaLaTeX\ and the \pkg{selnolig} package work well with the \href{http://www.ctan.org/pkg/babel}{\pkg{babel}} package. If your document loads the \pkg{babel} package, be sure to load the \pkg{selnolig} package \emph{after} the \pkg{babel} package, so that the additional hyphenation patterns provided by the \pkg{selnolig} package won't get clobbered by \pkg{babel}'s hyphenation settings. The \pkg{selnolig} package is also compatible with the \href{http://www.ctan.org/pkg/hyphsubst}{\pkg{hyphsubst}} package (which, if used, should be loaded with a \Verb+\RequirePackage+ statement \emph{before} the \Verb+\documentclass+ instruction).

\LuaLaTeX\ natively supports the so-called \textsc{utf}-8 input encoding. The \pkg{selnolig} package assumes that users make full use of this feature. In particular, if your document is in German, it is assumed that all vowels with diereses (Umlaute) are entered as \Verb|ä|, \Verb|ö|, and \Verb|ü| rather than as \Verb|\"{a}|, \Verb|\"{o}|, and~\Verb|\"{u}| (or, if you tend to use the \pkg{babel} \enquote{shortcuts}, as \Verb|"a|, \Verb|"o|, and~\Verb|"u|). Likewise, it's assumed that you enter the \enquote{Eszett} (\enquote{Scharfes~s}) character as~|ß| rather than as~|{\ss}|.\footnote{Strictly speaking, the use of the input characters with \enquote{built-in} diereses is required only for the operations of the package's \cmmd{nolig} and \cmmd{keeplig} commands. However, if you're going to use the \pkg{selnolig} package, you may was well use \Verb|ä|, \Verb|ö|, and \Verb|ü| consistently throughout your document(s).}

It is also assumed that you use the triple-f (modern) spelling form for words such as \texttt{Schifffahrt}, \texttt{Stofffarbe}, and \texttt{grifffest}.

Finally, all \pkg{babel}-style \Verb+"|+ ligature-suppressing shortcut instructions should either be removed entirely or replaced with \Verb+\breaklig+ instructions. On my \LuaLaTeX\ system (MacTeX\,2012), whenever a \Verb+"|+ command is encountered, a bad crash occurs that requires a reboot of the computer.


\section{Acknowledgments and license}

I owe a huge intellectual and programming debt to Patrick Gundlach and Taco Hoekwater, who responded kindly and generously with detailed computer code to various queries I posted to \href{http://tex.stackexchange.com}{\texttt{tex.stackexchange.com}}.\footnote{See especially the questions \url{http://tex.stackexchange.com/q/48516/5001}, \url{http://tex.stackexchange.com/q/63005/5001}, and
\url{http://tex.stackexchange.com/q/37443/5001}.} Without their expertise in programming in Lua and interfacing the lua code with \LaTeX, this package would not exist. They certainly deserve most of the credit for the lua code used by the \pkg{selnolig} package.

Felix Lehmann (a linguist and expert in morphology, i.e., the study of morphemes) and Steffen Hildebrandt (computer scientist extraordinaire) served as patient and careful testers of several \emph{early beta} versions of this package, uncovering bugs, pointing out unclear passages in the user guide, writing scripts to automate the discovery of syntactic errors in the package's \cmmd{nolig} and \cmmd{keeplig} instructions, and providing many excellent suggestions for important enhancements and other improvements. Steffen provided crucial modifications to the package's lua code to make possible the \cmmd{keeplig} macro. 

Even more importantly, Felix and Steffen created scripts to systematically and comprehensively test the package's German detection patterns for linguistic adequacy and (relative) completeness.
[Still to come: a brief summary of what Felix and Steffen have found, and a reference or two to their published work.] They wish to thank the Institut für Maschinelle Sprachverarbeitung at the Universität Stuttgart for granting them a license for the morphological analysis tool SMOR and, in particular, Helmut Schmid for his guidance and the \emph{Web-as-Corpus kool ynitiative} (\emph{WaCky}) for letting them use the SdeWaC corpus.\footnote{M.~Baroni, S.~Bernardini, A.~Ferraresi and E.~Zanchetta, 2009, The WaCky Wide Web: A Collection of Very Large Linguistically Processed Web-Crawled Corpora. \emph{Language Resources and Evaluation}, 43~(3): 209--226.} They also thank Rajesh Bhatt (University of Massachusetts--Amherst), Miriam Butt (Universität Konstanz), and Sabine Schulte im~Walde (Universität Stuttgart) for helping them find the right resources for their project.

The \href{http://www.ctan.org/tex-archive/support/rmligs}{\pkg{rmligs}} script lists hundreds of German language words for which various f\nobreak-liga\-tures should be suppressed. I created many of the initial German language ligature suppression rules of the \pkg{selnolig} package to treat the words listed in the \pkg{rmligs} package.\footnote{All versions of \pkg{rmligs} are archived at \url{http://www.j3e.de/ispell/igerman98/dict/}. A slightly modified version of the \pkg{rmligs} package's test file, now called \opt{rmligs-testfile.tex}, is included among the ancillary files distributed with the \pkg{selnolig} package.} 

Matthias Vogel very kindly informed me of a very useful and detailed set of macros, named \href{http://www.winedt.org/Macros/LaTeX/Ligatures-German.php}{Ligatures-German}, which he wrote for the WinEdt programmer's editor, to suppress f-ligatures by inserting the \pkg{babel}~\Verb+"|+ shortcut macro in the appropriate spots. Matthias' regular-expression based macros and a file he sent me containing a very extensive list of German words that need one or more f-ligatures suppressed led me to thoroughly refine and extend the scope of the \pkg{selnolig}'s ligature-suppressing commands for German words.

Barbara Beeton provided careful and incisive comments on an early version of this user guide and the English-language ligature suppression macros. Other contributors to \url{tex.stackexchange.com} and \url{comp.text.tex}, too numerous to name individually, also helped guide and influence the genesis of this package. To all of you, I express my sincere thanks.

The website \url{http://www.morewords.com} provides very convenient methods for searching English language words that may contain cases of ligature collisions across morpheme boundaries. For German words, the site  \url{http://corpora.informatik.uni-leipzig.de/?dict=de} provides a similar resource. 

The entire \pkg{selnolig} package is placed under the terms of the \LaTeX\ Project Public License, version~1.3 or later (\url{http://www.latex-project.org/lppl.txt}).
It has the status \enquote{maintained}.


\section{Structure of the package}

\subsection{Components of the package}

The \pkg{selnolig} package has the following components:
\begin{itemize}
\item The main \enquote{driver} file is called  \pkg{selnolig.sty}. It loads several other files and sets up the the package's main user macros, \cmmd{nolig} and \cmmd{keeplig}. These macros are explained in more detail in \cref{sec:syntax} below.
\item The package's user macros rely on lua code contained in the file \pkg{selnolig.lua}. 
\item Extensive lists of non-ligation rules for English and German language documents are provided in the files \pkg{selnolig-english-patterns.sty} and \pkg{selnolig-english-patterns.sty}. 
\item Supplemental hyphenation exception patterns, mostly for words that involve one or more ligatures that are to be suppressed, are contained in the files \pkg{selnolig-english-hyphex.sty} and \pkg{selnolig-english-hyphex.sty}.
\item A user guide (the document you're reading right now); the source code of the user guide is available in the file \pkg{selnolig.tex}. 

\item Ancillary files: the files \pkg{selnolig-english-test.tex} and \pkg{selnolig-german-test.tex} load the \pkg{selnolig} package as well as either \pkg{selnolig-english-wordlist.tex} or \pkg{selnolig-german-wordlist.tex}. They serve to demonstrate the output of the \pkg{selnolig} package when run on lists of English or German words that are candidates for non-use of ligatures. The files \pkg{selnolig-english-test.pdf} and \pkg{selnolig-german-test.pdf} contain the results of compiling the test programs.\footnote{The two \enquote{test} files also load the package \pkg{showhyphens} to indicate automatically all instances where \LuaLaTeX\ might insert hyphenation points.}

\end{itemize}


\subsection{The package's user commands} \label{sec:syntax}

The file \pkg{selnolig.sty} should be loaded with a \cmmd{usepackage} statement, generally with one or more options; see \cref{sec:options} for a discussion of the available options. After setting up several Boolean switches to structure the processing of options, the package next loads the file \pkg{selnolig.lua}, which contains the package's lua code.  

The package then sets up several user macros which build on the lua code:
\begin{enumerate}
\item The main user macro is called \cmmd{nolig}. Each \cmmd{nolig} instruction takes two arguments: a search string and a string that indicates the insertion point for the non-ligation \enquote{whatsit}. For example, the macro
\begin{Verbatim}
     \nolig{lfful}{lf|ful}
\end{Verbatim}
instructs \LuaLaTeX\ to suppress automatically the ff-ligature in words such as \enquote{shelfful}, \enquote{bookshelfful}, and \enquote{selffulfilling}. 

More than one ligature suppression point may be provided in the second argument of a \cmmd{nolig} instruction.\footnote{For instance, one \emph{could} specify \Verb+\nolig{Auflaufform}{Auf|lauf|form}+ to suppress both the fl and the ff ligature in this word. As I note in \cref{sec:debugon}, the \pkg{selnolig} package actually uses two separate \cmmd{nolig} commands to treat the ligatures in Auflaufform. }


It is possible to use \enquote{wildcard} characters in the search string, as long as these characters occur after the non-ligation point. For example, the file \pkg{selnolig-german-patterns.sty} employs the instruction 
\begin{Verbatim}
     \nolig{Aufl[aäeioöuü]}{Auf|l}
\end{Verbatim}
to search for words that start with \opt{Aufl} followed by a vowel.\footnote{This particular search string is used in order not to catch the abbreviated word \enquote{Aufl.}, which does \emph{not} get its fl-ligature suppressed.} Incidentally, it is not absolutely necessary, in the second argument of the \cmmd{nolig} command, to provide any material \emph{after} the vertical bar. However, the readability of the \cmmd{nolig} instructions may suffer if you suppress that material.

If you examine the \cmmd{nolig} instructions provided in the files \pkg{selnolig-german-patterns.sty} and \pkg{selnolig-english-patterns.sty}, you'll notice quickly that there's some redundancy built into the package's ligature suppression rules. For instance, the need to suppress the ff-ligature in the German verb \enquote{auffallen} is catered to both by \Verb+\nolig{auff}{auf|f}+ \emph{and} by \Verb+\nolig{ffall}{f|fall}+. This redundancy is there by design, because not all words that might fit the first pattern will also fit the second pattern, and vice versa. Building in some redundancy seems like a reasonable way to proceed.

The arguments of the \cmmd{nolig} command, as well as of the package's other user commands, are case-sensitive. 

\item The macro 
\begin{Verbatim}
     \keeplig{<word-fragment>}
\end{Verbatim}
lets users override \cmmd{nolig} instructions, by specifying words and word fragments for which typographic ligatures should \emph{not} be suppressed anywhere in the document. For a \cmmd{keeplig} macro to work properly, its argument should be a word (or word fragment) that includes as a subset words (or word fragments) treated by \cmmd{nolig} instructions. It is permissible to use lua-type wildcard characters in the argument of \cmmd{keeplig}. 

Having the \cmmd{keeplig} macro is very useful because it allows us to specify simpler, i.e., less restrictive, \cmmd{nolig} instructions: Any Type-II errors that may arise from having a slightly-too-broad \cmmd{nolig} macro can be addressed by providing judiciously chosen \cmmd{keeplig} macros.

\enlargethispage{1\baselineskip}

To give an example: If the \opt{ngerman} option is set, the package uses the macro 
\begin{Verbatim}
     \nolig{flich}{f|lich}
\end{Verbatim}
to break up the fl-ligature in the words brieflich, tariflich, trefflich, hilflich, verwerflich, beruflich, sträflich, höflich, glimpflich, unerschöpflich, Lauflicht, and begrifflich\textemdash and quite a few more words too. This macro is, unfortunately, a bit too broad because it also operates on words such as Pf\breaklig licht and verpf\breaklig lichten, for which the fl-ligature should \emph{not} be suppressed. Rather than provide a plethora of slightly more restrictive \cmmd{nolig} macros just to avoid including the Pflicht- and pflicht-words, the package provides the commands
\begin{Verbatim}
     \keeplig{Pflicht}
     \keeplig{pflicht}
\end{Verbatim}
to override the action of the \Verb+\nolig{flich}{f|lich}+ instruction for words that contain these two word fragments. Recall that the argument of |\keeplig| is case-sensitive; hence, two \cmmd{keeplig} instructions are needed.

Just as it is possible to override the action of a \cmmd{nolig} command with a subsequent \cmmd{keeplig} command, it is also possible to override the action of a \cmmd{keeplig} macro with a more specific \cmmd{nolig} command. For instance, it turns out that the two \cmmd{keeplig} commands stated in the preceding paragraph are themselves a bit too broad because they also affect the typesetting of the composite word \opt{Sumpflicht} (swamp light), for which the fl-ligature \emph{should} be suppressed. To address this case, the file \pkg{selnolig-german-patterns.sty} provides the macro 
\begin{Verbatim}
     \nolig{Sumpflicht}{Sumpf|licht}
\end{Verbatim}

Observe that we make use of the case sensitivity in the final \cmmd{nolig} instruction in order to avoid having it apply to words such as \enquote{Visumpflicht} (visa requirement). 

\item The macro \cmmd{breaklig}, which doesn't take an argument, is provided as a hopefully easy-to-remember version of the low-level \LaTeX\ command \Verb+\-\hspace{0pt}+. As its name suggests, you should insert this macro in places where you want to break up a ligature on an ad-hoc basis (and also wish to permit hyphenation to occur). For instance, to suppress the \emph{\mbox{sk}} ligature in the word \Verb+groundskeeper+ on a one-off basis, one might enter it as \enquote{\Verb+grounds\textbackslash breaklig keeper+} to get {\ebg \emph{groundskeeper} rather than \emph{ground\mbox{sk}eeper}.}\footnote{To suppress the {\ebg \emph{\mbox{sk}}} ligature globally for this word, as well as for words such as {\ebg \emph{greenskeeper}} and {\ebg \emph{miskeep}}, one could issue the directive \Verb+\nolig{skeep}{s|keep}+. The \pkg{selnolig} package does so.}

\end{enumerate}

Incidentally, the \pkg{selnolig} package does not provide a dedicated macro to override the action of a \cmmd{nolig} instruction on an ad~hoc basis, i.e., to force the use of a typographic ligature on a one-off basis. The \LaTeX\ command \Verb+\mbox{}+ already caters to this need.


The final few steps in the startup process depend on which language-related options are set:
\begin{itemize}
\item If \emph{no} language-specific options are in effect, the loading process terminates. Users may still use the instructions \cmmd{nolig}, \cmmd{keeplig}, and \cmmd{breaklig}, but no lists of language-specific \cmmd{nolig} macros are loaded.

\item If the \opt{english} option (or one of its synonymous options) is set, the files \pkg{selnolig-english-patterns.sty} and \pkg{selnolig-english-hyphex.sty} are loaded. The former file contains a long list of \cmmd{nolig} macros adapted to English language typographic usage; \Cref{sec:eng-listing} provides a complete listing of these macros. The latter file contains a list of hyphenation exceptions, mainly for words that contain one or more potential non-ligation points and for which \TeX's hypenation algorithm either misses valid hyphenation points or selects invalid hyphenation points; see \cref{sec:addlhyph} below.

\item If the \opt{ngerman} option (or one of its synonymous options) is set, the files \pkg{selnolig-german-patterns.sty} and \pkg{selnolig-german-hyphex.sty} are loaded. The former file contains ligature-suppressing instructions appropriate for German typographic usage; \cref{sec:germ-listing} lists its contents. The latter file provides additional hyphenation rules for German-language words.

\item If the user specifies both the \opt{english} and \opt{ngerman} options (or some of their synonymous options), \emph{both} language-specific style files will be loaded. Under normal circumstances, a user will probably want to load only one or the other set of language-specific files, but not both sets.
\end{itemize}



\section[The selnolig package's approach to breaking up ligatures]{The \pkg{selnolig} package's approach to breaking up ligatures}

The \cmmd{nolig} macros provided in the files \opt{selnolig-english-patterns.sty} (see \cref{sec:eng-listing}) and \opt{selnolig-german-patterns.sty} (see \cref{sec:germ-listing}) are primarily designed to break up ligatures\textemdash mainly f-ligatures, but potentially other ligatures as well\textemdash across \emph{morpheme} boundaries. 

\needspace{4\baselineskip}
Issues of ligating character pairs and triples across morpheme boundaries can occur 
\begin{itemize}
\item if two independent or \enquote{main words} (Stammwörter) are joined together: \mbox{rooftop}\slash rooftop, \mbox{newspaper}\slash newspaper, \mbox{Schilffeld}\slash Schilffeld, \mbox{Brieftaube}\slash Brieftaube; \phantom{x}   
\item between a prefix and main word: mi\mbox{st}rust\slash mistrust, di\mbox{sp}lay\slash display, \mbox{aufleben}\slash aufleben, \mbox{auftun}\slash auftun; and \phantom{x}
\item between a main word and a suffix: \mbox{shelfful}\slash shelfful, \mbox{dwarflike}\slash  dwarflike, \mbox{kopflos}\slash kopflos, and \mbox{Zöpflein}\slash Zöpflein. \phantom{x}
\end{itemize}

The general rule for all of these cases is to suppress typographic ligatures that cross such morpheme boundaries.
For German words, the following exceptions and adjustments apply:\footnote{These adjustments are culled from the rules stated in the \emph{Duden} and  various websites that have taken an interest in this subject.}
\begin{itemize}
\item Should the combination of a main word and suffix give rise to an fi or ffi ligature, this ligature is \emph{not} suppressed. Examples: streifig and affig. However, the fi and ffi ligatures \emph{are} suppressed if two main words are joined together: Schilfinsel, Zupfinstrument, and Baustoffingenieur.

\item For some cases potentially giving rise to an fl-ligature at the juncture of a main word (Stammwort) and a suffix, preference is conventionally given to \enquote{how the syllables are pronounced and how a word would be hyphenated} (according to the Duden), leading to a suppression of the fl-ligature. For instance, the words schweflig (sulfurous), teuflisch (devilish), and Verzweiflung (despair) have their fl-ligatures suppressed even though in each case the~f and~l characters belong to the same underlying morpheme, {viz.}, Schwef(e)l, Teuf(e)l, and Zweif(e)l. For these words, the morphemological suffixes are clearly -ig, -isch, and -ung,  rather than -lig, -lisch, and -lung. 
Nevertheless, usage for these and similar cases is \emph{not} to employ the fl-ligature. 

%To the best of my understanding, this convention may be based on the fact that these cases all involve the elision of the~e character between the~f and~l characters of the associated morphemes. The non-use of the fl-ligature may thus represent a subtle (possibly very subtle) nod towards how the associated morphemes would be written \emph{if} the~e character weren't being elided. The fact that the syllables within these words all happen to be divided between the~f and~l characters may be a coincidence rather than the primary reason for this typographical practice.

This convention also appears to govern the typesetting of words such as knifflig (tricky) and mufflig (grouchy), as well as that of the first-person-singular forms of verbs such as büffeln, löffeln, schaufeln, stiefeln, and zweifeln: they are rendered \emph{without} the fl-ligature, i.e., as büffle, löffle, schaufle, stiefle, and zweifle, respectively.

\item If a word could \emph{end} with an fl-ligature even though the~f and~l technically belong to different morphemes (say, because of an abbreviation that's in effect), the fl-ligature \emph{is} used. E.g., one writes Aufl.\ \emph{with} an fl ligature. But, when spelled out, the word should be typeset as Auflage.

This convention further suggests that it's permissible to use the ffi- and ffl-ligatures in abbreviated names such as Steffi and Steffl even though they do not involve a period. 

This convention could also be taken to imply that the~ft and~\char"E187\ ligatures may be used if they occur at the very ends of words and word fragments\textemdash e.g., geschärft, Unbedarftheit, and erscha\char"E187\textemdash but that they should be suppressed when -f-te, -f-ten, -f-tes, etc.\ suffixes are involved\textemdash e.g., gestreifte, schlürftest, and rafften. All of these suffixes form syllables that start with~a~\enquote{t}. Note, though, the deliberate use of the expression \enquote{taken to imply} at the start of this paragraph: I have so far \emph{not} encountered any kind of authoritative discussion of this particular typographic concern. For now, the \pkg{selnolig} package \emph{does} break up the~ft and~\char"E187\ ligatures if the words include suffixes that are syllables in their own right and start with~\enquote{te}.


\item Here's a separate case for which I have not yet found a clear rule. If a morpheme ends in~\enquote{ft} (e.g., Saft and Luft) and is followed by a suffix that starts with an~i, as in \opt{saftig} and \opt{luftig}, one could typeset these words as either as sa\mbox{ft}ig and lu\mbox{ft}ig because the \opt{ft} character pair belongs to a single morpheme, \emph{or} one could give preference to the way the words are hyphenated and the component syllables are pronounced and thus \emph{not} use the ft-ligature, i.e., to typeset them as saftig and luftig. For now, the \pkg{selnolig} package implements the latter option. As already noted, however, I have not yet found any authoritative references on how to treat this case. Clear guidance on this typographical issue would be much appreciated.

\end{itemize}



\section{Package options, Additional ligature-related issues}
\label{sec:options}

\subsection{Main language options}

The \pkg{selnolig} package currently offers two main language-specific options: 
\begin{itemize}
\item \opt{english}; synonyms: \opt{british}, \opt{ukenglish}, \opt{UKenglish}, \opt{amer\-ican},  \opt{usenglish}, \opt{USenglish}, \opt{cana\-dian}, \opt{australian}, and \opt{new\-zealand}.
\item \opt{ngerman}; synonyms: \opt{german}, \opt{austrian}, \opt{naustrian}, \opt{swiss}, and \opt{swiss\-german}.
\end{itemize}
These language options may be used either individually or jointly. Indeed, this package's user guide was compiled with both the \opt{english} and \opt{ngerman} options set.

See \cref{sec:eng-listing,sec:germ-listing} for the complete listings of the package's English and German language ligature suppression rules.



\subsection{Other package options}

\subsubsection[English language case: The broadf and hdlig options]{English language case: The \opt{broadf} and \opt{hdlig} options} \label{sec:eng-opt}

The ligature suppression patterns listed in \cref{sec:eng-listing} for English language words are grouped into four parts. The first two parts concern the suppression of various f-ligatures. Part~1 provides a fairly limited, or \enquote{basic}, set of patterns that will always be executed, and Part~2 contains a broader set of ligation suppression rules that will be executed if the \opt{broadf} option is specified. 

For English-language documents, only a fairly small number of the f-ligature suppression rules is enabled by default, i.e., if the \opt{broadf} option is not enabled. Eliminating \emph{all} f-ligatures that cross morpheme boundaries simply does not appear to be a major concern in English-language typography. Whereas many (maybe even most?) people would agree that it advisable not to use the ffi-ligature in words such as chaffinch and wolffish, and not to use the ffl-ligature in words such as scofflaw and offload, there appears to be far less of a perceived need to suppress the fi (ffi) ligature in the far more commonly occurring words that end in~f (ff) followed by the -ing, -ish, -ier, -iest, -ily, and -iness particles.\footnote{Examples of such words are sur\mbox{fi}ng, oa\mbox{fi}sh, lea\mbox{fi}er, goo\mbox{fi}est, flu\mbox{ffi}ly, and goo\mbox{fi}ness.} The same goes for the~fl (ffl) ligature in words that end in~f (ff) followed by~-ly.\footnote{Examples are \mbox{aloofly} and \mbox{gruffly}.} That is why only a few f-ligature suppression macros are enabled by default if the \opt{english} option is set. To enable the broader set of f-ligature suppression rules, users must set the \opt{broadf} option explicitly.

My choices regarding which f-ligature suppression rules belong to the \enquote{basic-f} and \enquote{broadf} groups are almost entirely pragmatic. They are certainly not based on any overriding English-language typographic principles (which, possibly, don't even exist for the case at hand). However, if anyone happens to have a strong view on whether either \emph{fewer} or \emph{more} f-ligature suppression macros should be included in the \enquote{basic} group\textemdash especially if you can provide references to such discussions in learned circles\textemdash I would love to hear from you.


Part 3 of the file \pkg{selnolig-english-patterns.sty}, which is enabled if the \opt{hdlig} option is set, provides ligature suppression patterns for the \enquote{historic} (Adobe uses the term \enquote{quaint}) \mbox{ct}, \mbox{st}, and \mbox{sp} ligatures, in words such as arctangent (better than ar\mbox{ct}angent), painstaking (better than pain\mbox{st}aking), and display (better than di\mbox{sp}lay). The sp ligature is also suppressed for words of Greek origin containing the \opt{sph} character triple, such as atmosphere and hemisphere, because in these cases the \opt{ph} character pair (which derives from the Greek letter $\phi$, or~$\varphi$) is pronounced like~\enquote{f\,} and should not be obscured by a preceding~sp ligature.

Setting the \opt{hdlig} option also enables ligature suppression rules for ligatures such as \emph{th}, \emph{at}, and~\emph{et}. These ligatures might occur in words such as \emph{ligh\mbox{th}ouse} and \emph{po\mbox{th}ole}, \emph{arom\mbox{at}herapy} and \emph{alb\mbox{at}ross}, and \emph{nin\mbox{et}y} and \emph{non\mbox{et}heless}. Ligature suppression rules are provided for the following discretionary ligatures: \emph{th}, \emph{at}, \emph{et}, \emph{as}, \emph{is}, \emph{us}, {\ebg \emph{sk}},  \emph{ll}, and~\emph{fr}. Part~3 of \cref{sec:eng-listing} lists these rules.

Part 4 of this file, which is also processed if the \opt{hdlig} option is set, deals with cases where one discretionary typographic literature, say \emph{as}, pre-empts the use of a typographic ligature, say \emph{st} or~\emph{sp}, in words such as \emph{f\mbox{as}t}\slash \emph{fa\mbox{st}} and \emph{cl\mbox{as}p}\slash \emph{cla\mbox{sp}}. Note that the issue being addressed in this part is not that of a ligature crossing a morpheme boundary but of the pre-emption of one typographic ligature by another ligature within the same morpheme. This issue is discussed in more detail in \cref{sec:preempt}.



\subsubsection{Supplentary hyphenation exception patterns} \label{sec:addlhyph}

\TeX's hyphenation algorithms are widely acknowledged to be very good. However, for the English language case at least, it tends to miss quite a few permissible hyphenation points when dealing with words that end in -f-ing, -ff-ing, -f-ier, -ff-ier, -f-iest, -f-less, -f-like, etc. Hyphenation exception lists are provided in the files \pkg{selnolig-english-hyphex.sty} and \pkg{selnolig-german-hyphex.sty}, respectively, for English and German words.

The German-language hyphenation exception list is the shorter of the two. This is because it is assumed that writers of German-language documents use the \pkg{babel} package while setting the option \opt{ngerman} option (or one of the related options); doing so also loads specialized hyphenation patterns suitable for German text.\footnote{As was already noted earlier, the \pkg{selnolig} package is also compatible with the \pkg{hyphsubst} package.} 

It is possible to instruct \pkg{selnolig} \emph{not} to load the package's hyphenation exception lists. You may want to do so, say, if you must use UK-English hyphenation patterns and therefore mustn't make use of the US-English hyphenation patterns provided by the package. (To the best of my knowledge, though, most of the hyphenation patterns indicated in \pkg{selnolig-english-hyphex.sty} are common to UK and US English.) To skip loading the additional hyphenation patterns when invoking the \pkg{selnolig} package, you should specify the option \opt{noadditional\-hyphen\-a\-tion\-patterns}.\footnote{I am obviously not trying to make it too easy to invoke this option~\dots}

As was already noted in \cref{sec:anythingelse}, if you use the \pkg{babel} package with, say, the \opt{ngerman} option, be sure to load \pkg{selnolig} package \emph{after} the \pkg{babel} package. That way, the \pkg{selnolig} package's additional hyphenation exception patterns won't be overridden by \pkg{babel}'s settings.

Incidentally, if the files \pkg{selnolig-english-hyphex.sty} and \pkg{selnolig-german-hyphex.sty} are located in a directory that's in the search path of your TeX distribution, these packages may be loaded by users via the usual \cmmd{usepackage} statements without having to load the entire \pkg{selnolig} package.


\subsection{Composite words made up of two different sets of primitive words}

More so in German than in English, there may be composite words which are made up of two different pairs of primitive words. For instance, the words \opt{Saufladen} and \opt{Wachstube} may be constructed as \opt{Sauf-laden}\slash \opt{Sau-fladen} and as \opt{Wachs-tube}\slash \opt{Wach-stube}, respectively. In one case, using the fl and st ligatures would be wrong; in the other, using the ligatures would help greatly in indicating the intended meaning of the composite words. 
For words such as the ones given above, software isn't\textemdash and won't be for a quite a while to come\textemdash smart enough to \enquote{know} on its own which possible meaning is intended. Writers, of course, can choose to insert explicit hyphen characters to indicate unambiguously the intended meaning.

It turns out that if the \opt{ngerman} option is set and the \pkg{babel} package is loaded as well, the \opt{selnolig} package will break up the fl ligature in \opt{Saufladen} but not the st ligature in \opt{Wachstube}, i.e., the words will be typeset as \enquote{Saufladen} and \enquote{Wachstube}, respectively. If that's not what you want, you'll need to mark up the words explicitly, say as follows: \Verb+Sau\mbox{fl}aden+ and \Verb+Wachs\breaklig tube+. 

A related case is that of the word \opt{Chefinnenleben}, which can be constructed as \opt{Chefinnen-leben} (lives of female bosses) or as \opt{Chef-innenleben} (inner life (or lives) of a boss): the particle \enquote{innen} could either be a suffix to \enquote{Chef} or a prefix to \enquote{Leben}.  The macros of the \pkg{selnolig} package are set up, by default, \emph{not} to break up the fi ligature in words such as Chefin and Chefinnen, in keeping with the rule that the fi ligature is permitted if the suffix starts with an~\enquote{i}. In contrast, it will break up the fi ligature in the longer words Chefinnenleben and Chefinnenräume, as in these cases the assumption is that the \opt{innen} particle acts as a prefix to the final part of the composite word. If that's \emph{not} what you want, i.e., if you do mean to discuss various things pertaining to female bosses, be sure to use \Verb+\mbox{fi}+ instructions where appropriate. Better yet, use hyphens and write the words in question either as Chef-Innenleben and Chef-Innenräume or as Chefinnen-Leben and Chefinnen-Räume, respectively.



\subsection{Providing additional ligature suppression patterns}

As already noted, I do not claim that the non-ligation search-and-insert patterns set up in \pkg{selnolig-english-patterns.sty} and \pkg{selnolig-german-patterns.sty} are complete or, for that matter, ever will be entirely complete. If you come across words containing ligatures that ought to be suppressed but aren't caught, it is straightforward to create one or more new non-ligation rules to deal with the cases you've discovered.

Suppose, say, that you need to prepare a special edition of Thomas Mann's novel \enquote{Der Tod in Venedig} and that you have chosen to use an \enquote{Antiqua} (Roman) font since fewer and fewer people nowadays can manage with ease to read text set in a period-appropriate {\blackletterfont blackletter} font. During these preparations, you might notice that the novel contains the word \opt{inbegriffleitend}\footnote{This word really does occur in the aforementioned novel!} and that the \pkg{selnolig} package does not (yet) appear to include a macro to suppress the unwanted ffl-ligature for this word. To address this problem, while simultaneously creating a search pattern that will also catch cases of inappropriate ffl-ligatures in the (hopefully quite a bit more common) words \opt{Jugendtreffleiter} and \opt{Kunststoffleitung}, you could add the following \Verb+\nolig+ macro to your document's preamble:
\begin{Verbatim}
     \nolig{ffleit}{ff|leit}
\end{Verbatim}
With this macro in place, the words would now be typeset as inbegriffleitend, Jugendtreffleiter, and Kunststoffleitung.\footnote{The file \pkg{selnolig-german-patterns.sty} provides the macro \Verb+\nolig{fleit}{f|leit}+ to cover these and further words.}



\subsection[How to use the selnolig package to suppress certain ligatures globally]{How to use the selnolig package to suppress certain ligatures \emph{globally}}
\label{sec:global-nolig}


The main purpose of the \pkg{selnolig} package is, obviously, to disable certain ligatures selectively. However, it can also be used to suppress ligation globally for selected character pairs.\footnote{I first became aware of the potential need for such a feature after reading Frank Mittelbach's posting, \href{http://tex.stackexchange.com/q/61042/5001}{Suppress certain ligatures generally}, on \url{tex.stackexchange.com}. } 

For instance, suppose that you are typesetting a Turkish text, which features both a dotted and a dotless~i, \emph{viz.},~\enquote{\char"0131}. I understand that in Turkish typesetting practice, \emph{no} fi and ffi ligatures should be employed so as not to create doubt regarding which \enquote{i} character follows the \enquote{f} character. However, other f-ligatures (such as ff, fl, and~ffl) may presumably be employed, because doing so wouldn't create similar readability and intelligibilty problems. To address the global need not to use fi and ffi ligatures while keeping other f-ligatures in play, one could issue the command
\begin{Verbatim}
     \nolig{fi}{f|i}
\end{Verbatim}
in the preamble of the document.

\bgroup \ebg

Or, suppose that you have a font that provides ligatures for the \mbox{fb}, \mbox{fh}, \mbox{fj}, and \mbox{fk} character pairs as well as, possibly, the \mbox{ffb}, \mbox{ffh}, \mbox{ffj}, and \mbox{ffk} character triples. If you wanted to suppress the four former f-ligatures globally (and also break up the latter ligatures as ff-b, ff-h, ff-j, and~ff-k, respectively), you could do so by issuing the following commands: \egroup
\begin{Verbatim}
     \nolig{fb}{f|b}
     \nolig{fh}{f|h}
     \nolig{fj}{f|j}
     \nolig{fk}{f|k}
\end{Verbatim}

In fact, these commands are provided automatically if the package's \opt{ngerman} option is set.\footnote{These four macros are also enabled if the \pkg{selnolig} package's \opt{english} and \opt{broadf} options are set.} This is done because I was unable to come up with a single instance of a \emph{German} language word involving these character combinations that doesn't also involve a morpheme boundary collision.


Of course, your document may contain some \emph{non-German} language words as well, for which you would not necessarily want to suppress these ligatures. Suppose, say, that you need to typeset the name \opt{Kafka} and do not wish to suppress the {\ebg \mbox{fk}}-ligature for this specific word. To override the global setting created by the \Verb+\nolig{fk}{f|k}+ macro, you could write each instance of this word as 
\Verb+Ka\mbox{fk}a+
to generate Ka\mbox{\ebg \mbox{fk}}a instead of Kafka. Alternatively\textemdash and this is the method implemented by the \pkg{selnolig} package\textemdash one may provide suitable \cmmd{keeplig} macros to preserve the {\ebg\mbox{fk}}-ligature in names such as {\ebg Kafka, Safka, Piefke, Potrafke, Sprafke, Shirafkan, and Tirafkan}. 



Or, suppose the \pkg{selnolig} package's \opt{ngerman} option is enabled and your document features some words of \emph{Nordic} origin containing the \opt{fj} character pair, such as \opt{Sognefjord} and \opt{Dovrefjell}. Observe that because the \opt{fj} character pair contained in these words does not span a morpheme boundary, the \mbox{fj}-ligature should not be broken up, i.e., the words should be typeset as Sognefjord and Dovrefjell, respectively.  \cmmd{keeplig} macros are therefore provided for words containing the particles fjord, fjör, fjell, and fjäll as well as for names such as Eefje, Sufjan, Prokofjew, and Astafjew.



\subsection{What if one ligature pre-empts a subsequent, more appropriate ligature?} \label{sec:preempt}

If a font provides many discretionary ligatures, the likelihood increases that the use of a ligature for the first two characters of a \emph{character triple} might pre-empt the use of a more appropriate ligature for the last two characters of that triple.\footnote{To be sure, the issue of ligature pre-emption is not limited to \enquote{discretionary} ligatures; it can also occur with \enquote{common} f-ligatures. Suppose that a certain font provides ff, fi, and fl ligatures but no ffi and ffl ligatures, and consider how words containing \opt{ffi} and \opt{ffl} character triples will be typeset. Left to its own devices, \TeX\ would let the leading ff-ligature pre-empt the trailing fi- and fl-ligatures, resulting in typographically incorrect outcomes for words such as wol\mbox{ff}ish (better: wolf\mbox{fi}sh), sa\mbox{ff}lower (safflower), au\mbox{ff}inden (auffinden) and Scha\mbox{ff}leisch (Schaffleisch). \label{fn:triple}} 
In this section, we examine the use of \cmmd{nolig} instructions to address this contingency, focusing on cases of~\emph{st}, \emph{sp}, \emph{th}, and~\emph{ta} character pairs being preceded by character pairs (for which the font provides ligatures) that end in~\emph{s} or~\emph{t}, respectively. This focus is dictated largely by the discretionary ligatures provided by the text font used for this user guide (Garamond Premier Pro). Other ligature-rich fonts may provide further possibilities for one ligature inappropriately pre-empting that for a trailing character pair.\footnote{For the Garamond Premier Pro text font, I've discovered the following preculiar  exception to the general rule that \TeX\ always gives precedence to a ligature for the first two characters of a character triple: for the character triple \opt{fis} (as in \opt{fist} and \opt{fish}), \TeX\ gives preference to the trailing \emph{is} ligature over the preceding \emph{fi} ligature, causing these words to be typeset as \emph{f\mbox{is}h} and \emph{f\mbox{is}t}, respectively. I can't tell if this outcome is a conscious design feature or a bug.

For now, \pkg{selnolig} is set to override this behavior, i.e., to always give preference to the leading \emph{fi} ligature over the trailing \emph{is} ligature for words that contain the strings \opt{fist} and \opt{fish}; hence, they'll be rendered as \emph{fist} and \emph{fish}, respectively. Note that if the \opt{broadf} option was set, this setting implies that words such as {\em deafish, dwarfish, elfish, oafish, selfish, unselfish, wolfish, draffish, giraffish, gruffish, offish, raffish, sniffish, standoffish, stiffish}, and \emph{toffish}, as well as the associated adverbs ending in \emph{-ly}, will not feature an \emph{is} ligature. Of course, if the \opt{broadf} option is not in effect, the \emph{fi} and \emph{ffi} ligatures will automatically preempt the \emph{is} ligature in these words.}



\subsubsection{Ligatures for \emph{as}, \emph{is}, and \emph{us} that pre-empt an \emph{st} ligature}

Suppose that the text font in use provides ligatures for the \emph{as}, \emph{is}, and \emph{us} character pairs as well as for the \emph{st} character pair. By \TeX's rules for forming typographic ligatures, words that contain the character \emph{triples} \opt{ast}, \opt{ist}, or \opt{ust} will see the first two characters ligated, pre-empting the use of a typographic ligature for the trailing \emph{st} character pair. There are three separate reasons why this outcome may not be desirable.

First, given the rather distinctive look of the \emph{st}~ligature, the word \opt{stochastic} may look a bit odd if the \emph{st} ligature is used only once\textemdash\emph{stoch\mbox{as}tic}\textemdash simply because the \emph{as} ligature pre-empts the second \emph{st} ligature; readers may prefer the look of \emph{stocha\mbox{st}ic}. Second, non-use of the st/\emph{st} ligature may be undesirable if the same word occurs twice and in close visual proximity, once set in the upright font shape\textemdash for which there are no ligatures for the \opt{as}, \opt{is}, and \opt{us} character pairs, and hence for which the issue of ligature pre-emption doesn't arise\textemdash and once in italics: must vs.\ \emph{m\mbox{us}t}; readers may prefer the look of must vs.\ \emph{mu\mbox{st}}. Taking this matter to a (slight?!) extreme: Do you prefer the look of \emph{Do f\mbox{as}t festive f\mbox{is}ts foster f\mbox{us}tiness?} or that of \emph{Do fa\mbox{st} festive fi\mbox{st}s foster fu\mbox{st}iness?}

Third, there may be cases where an \emph{as} ligature not only pre-empts a subsequent \emph{st} ligature but also spans a morpheme boundary, as in the words \emph{infr\mbox{as}tructure} and \emph{se\mbox{as}trand}.\footnote{This case was already noted in \cref{fn:triple}, where two words are noted for which the ff-ligature, which might improperly pre-empt fi- and fl-ligatures, happens to span a morpheme boundary.} For such words, the \emph{as} ligature should probably be suppressed in any case to increase the words' legibility: \emph{infra\mbox{st}ructure} and \emph{sea\mbox{st}rand}.

If the \opt{hdlig} option is set, it is assumed that you prefer giving preference to the distinctive-looking \emph{st} ligature over \emph{as}, \emph{is}, and \emph{us} ligatures. The following commands are therefore provided:\footnote{Be aware, though, that the second of these three commands, while correct for most words that contain the string \opt{ist}, unnecessarily suppresses the \emph{is} ligature for words where the \emph{st} character pair crosses a morpheme boundary. Examples of this case are words that start with \emph{dis-t\ldots}\textemdash e.g., \emph{distend, distribute, distrust, disturb}\textemdash or with \emph{mis-t\ldots}\textemdash e.g., \emph{mistake, mistranslate, mistype}. (Note that the st/\emph{st} ligature is already\textemdash and appropriately!\textemdash suppressed for these words.) At this time there are no plans to address this (overall minor?) problem.}
\begin{Verbatim}
     \nolig{ast}{a|st}
     \nolig{ist}{i|st}
     \nolig{ust}{u|st}
\end{Verbatim}



\subsubsection{Ligatures for \emph{as}, \emph{is}, and \emph{us} that pre-empt an \emph{sp} ligature}

The same three reasons for not letting \emph{as}, \emph{is}, and \emph{us} ligatures pre-empt an \emph{st} ligature also apply to the case of the equally distinctive looking \emph{sp} ligature. The \pkg{selnolig} package therefore provides macros to ensure the use of the trailing \emph{sp} ligature in words such as \emph{clasp}, \emph{hasp}, \emph{hispanic}, \emph{raspberry}, \emph{teaspoon}, \emph{wasp}, \emph{crisp}, \emph{lisp}, \emph{whisper}, \emph{wispy}, and \emph{cusp}. 
[Still need to figure out the following: Why isn't the \emph{sp} lig shown in \emph{clasp} and \emph{lisp} in this list, even though the \emph{as} and \emph{is} ligs aren't being used and hence can't be pre-empting the \emph{sp} lig?!]



\subsubsection{Ligatures for \emph{at} and \emph{et} that pre-empt a \emph{th} ligature}

Suppose that a font provides ligatures for the \emph{at}, \emph{et}, and \emph{th} character pairs. By \TeX's rules for forming ligatures, without special intervention the word \opt{mathematics} will be typeset as \emph{m\mbox{at}hematics} rather than as \emph{mathematics} because the \emph{at} ligature pre-empts the \emph{th} ligature. The same happens for words such as \emph{b\mbox{at}h}, \emph{K\mbox{at}hryn}, and \emph{p\mbox{at}hology}.\footnote{A longer list of words for which the \emph{at} ligature pre-empts the \emph{th} ligature is given in the ancillary document \pkg{selnolig-english-test.pdf}. }
Given the prevalence and distinctive pronuciation of the \opt{th} character pair in the English language, as well as the high frequency of this character pair in words of Greek origin (for which the Latin-alphabet \opt{th} character pair derives from the Greek character $\theta$, or~$\vartheta$), it seems undesirable to let the \emph{at}-ligature pre-empt the \emph{th} ligature for these words. 

Fixing the \emph{at}--\emph{th} ligature pre-emption issue globally, e.g., via \Verb+\nolig{ath}{a|th}+, is not completely innocuous because doing so will also suppress the \emph{at} ligature for words such as \opt{boathook}, for which the \emph{th} ligature would span a morpheme boundary and thus shouldn't be employed anyway. For such words, then, there's no need to suppress the \emph{at} ligature. These cases, fortunately, can be dealt with by providing \cmmd{keeplig} macros that deliberately let the \emph{at} ligature take precedence over the trailing \emph{th} ligature.

Suppressing an \emph{et} ligature in favor of a subsequent \emph{th} ligature via \Verb+\nolig{eth}{e|th}+ is almost universally correct, either because the \emph{th} ligature \emph{should} take precedence\textemdash as in the words \emph{ethics}, \emph{methane}, and \emph{teeth}\textemdash or because the \emph{et} ligature would cross a morpheme boundary and hence shouldn't be used anyway, as in the words \emph{forethought} and \emph{rethink}. 

I say that it's \emph{almost} universally correct to do so because there are some words, such as \opt{Beethoven}, \opt{prophethood}, and \opt{sweetheart}, for which the \emph{th} ligature would be inappropriate anyway and hence the use of the \emph{et} ligature would be unproblematic. 
To address this issue, \cmmd{keeplig} macros are provided for these words, deliberately letting the \emph{et} ligature take precedence over the \emph{th} ligature and resulting in them being typeset as \emph{Beethoven}, \emph{prophethood}, and \emph{sweetheart}, respectively.\footnote{Note that this method works if the font being used provides \emph{both} \emph{et} and \emph{th} ligatures. If the text font you employ provides only the \emph{th} ligature but not the \emph{et} ligature, these \cmmd{keeplig} macros should be disabled.}


\subsubsection{Ligatures for \emph{at} and \emph{et} that pre-empt a \emph{ta} ligature}

There seem to be only very few words for which an \emph{at} ligature might inappropriately pre-empt a more important \emph{ta} ligature. One such word is \opt{atap}, which may be more readable if it's typeset as~\emph{a\mbox{ta}p} rather than as \emph{atap}.\footnote{It's not advisable, however, to specify a macro such as \Verb+\nolig{atap}{a|tap}+ to address this case, because of words such as \emph{catapult} and \emph{catacomb}, for which the use of the \emph{at} ligature is presumably innocuous. Somebody please correct me if this assumption is not correct.}  Because of the apparent paucity of such cases, I have decided for now not to provide specific ligature suppression rules to handle them.

To the best of my (admittedly not exhaustive) knowledge, all words for which an \emph{et} ligature might inappropriately pre-empt the use of a trailing \emph{ta} ligature are words for which the \emph{et} ligature crosses a morpheme boundary and hence probably shouldn't be used anyway.\footnote{Examples are {\em betake, betatter, bristletail, caretaker, cheetah, detach, detail, detain, dovetail, foretaste, horsetail, pretake, pretax, retable, retack, retard, retarget, timetable, whitetail, \emph{and} wiretap}. Incidentally, the author of the \pkg{selnolig} package has a slight preference for seeing his surname typeset as \emph{Loretan} rather than as \emph{Loretan}\ldots} As such, the \emph{et}-related ligature suppression rules already in place, which are set up to deal with morpheme boundary crossing cases, should suffice to catch these cases as well.




\section{Further issues}

\subsection{Known bugs}

Remark: The bugs in the following list may turn out to be related, i.e., may be caused by a single bug in the package's lua code.
\begin{enumerate}
\item The \cmmd{nolig} search-and-nolig-whatsit-insertion patterns do not appear to work properly on the final word in the argument of a command (e.g., |\footnote{}| and |\section{}|) \emph{unless} that  word (including any trailing punctuation mark) is followed by one or more space characters before the closing curly brace of the command's argument is encountered. 

For instance, the fl ligature in \enquote{kop\mbox{fl}os} is not broken up by either |\footnote{kopflos.}| or |\section{Kopflosigkeit}|. The package does work as expected if the commands are modified to |\footnote{kopflos. }| and |\section{Kopflosigkeit }|.

\item The \cmmd{nolig} search-and-insert patterns also don't seem to work on words (including, if present, any trailing punctuation marks) that are followed immediately by a |%| (comment) character. The workaround is the same as for the preceding bug: be sure to leave one or more spaces between the word and the comment character.

\item If the content of an \cmmd{item} directive in an \opt{itemize} or \opt{enumerate} environment \emph{ends} with a word (including an associated punctuation mark) that contains a ligature that should be suppressed \textemdash i.e., if it is followed immediately by another \cmmd{item} directive or an \Verb+\end{itemize}+ or \Verb+\end{enumerate}+ statement\textemdash the ligature suppression again fails. The remedy in this circumstance is to leave a blank line between the end of one \cmmd{item}'s content and the next \cmmd{item} instruction or the \Verb+\end{itemize}+ or \Verb+\end{enumerate}+ instruction.

\item If the final word (again, possibly, with an associated punctuation character) in a sentence immediately \emph{prior} to the start of an \opt{enumerate}, \opt{itemize}, or other such environment contains a ligature that should be suppressed, the |\nolig| macro again will not work properly. The recommended remedy is to leave a blank line between that sentence and the start of the environment in question. Inserting an \enquote{invisible} instruction, such as \Verb+\vphantom{x}+, also works.

\end{enumerate}

I'm not sure if the following matter constitutes a bug or \enquote{just} a case of incompatibility between two packages. The \pkg{selnolig} package does not appear to interact well with the \pkg{ngerman} package; however, as was noted earlier, it interacts nicely with the \pkg{babel} package (with one or more of the \opt{ngerman}, \opt{german}, \opt{austrian}, and \opt{naustrian} options set). Unless someone can convince me that using the \pkg{ngerman} package is truly preferable to using the \pkg{babel} package with one of the available German language options, I probably won't bother figuring out how to fix this incompatibility.

\subsection{Writing ancillary information about the package's activity to the \opt{.log} file} \label{sec:debugon}

By default, none of the inner workings of the \pkg{selnolig} package are written to the \opt{.log} file. However, if you execute the command \cmmd{debugon}, detailed information about each pattern match that is encountered is written to the \opt{.log} file. Incidentally, because of the built-in redundancy of some of the \cmmd{nolig} command, it is possible that more than one pattern match will be found for a given word. E.g., for the verb \enquote{auffahren}, two separate \cmmd{nolig} commands simultaneously apply, and the following lines are written to the \opt{.log} file:
\begin{Verbatim}
     pattern match: auffahren - auff
     pattern match: auffahren - ffahr
     Do ligature suppression for: auffahren
     Inserting noliga whatsit before glyph: f
\end{Verbatim}

It is also possible that words with more than one ligature suppression point are found. For example, if the word \enquote{Auflaufform}\textemdash which happens to have both an fl- and an ff-ligature that should be suppressed\textemdash is encountered, the following lines are written to the \opt{.log} file; note that in this case, two separate \cmmd{nolig} commands \enquote{catch} the fl and ff ligatures:
\begin{Verbatim}
     pattern match: Auflaufform - fform
     pattern match: Auflaufform - Aufl[aäeioöuü]
     pattern match: Auflaufform - auff
     pattern match: Auflaufform - flauf
     Do ligature suppression for: Auflaufform
     Inserting noliga whatsit before glyph: l
     Inserting noliga whatsit before glyph: f
\end{Verbatim}


To terminate the writing of the debugging-related information to the \opt{.log} file, one may execute the command \cmmd{debugoff}.

Having the commands \cmmd{debugon} and \cmmd{debugoff} could be useful if you're writing your own \cmmd{nolig} and \cmmd{keeplig} commands and discover some ligature suppression problems which occur only in a small subset of your document. By bracketing this subset with a pair of \cmmd{nolig} and \cmmd{keeplig} commands, you limit the writing of debugging-related information to the \opt{.log} file, making the amount of information you'll need to plow through hopefully be quite manageable.

\subsection[Suspending and restarting the operation of selnolig's macros]{Suspending and restarting the operation of \pkg{selnolig}'s macros}

By default, \pkg{selnolig}'s macros are switched on if the package is loaded. If you want to suspend their operation at some point in the document, you may issue the command
\begin{Verbatim}
     \selnoligoff
\end{Verbatim}
Conversely, if \pkg{selnolig}'s macros need to be switched back on, you should issue the command
\begin{Verbatim}
      \selnoligon
\end{Verbatim}

Incidentally, encasing a \cmmd{selnoligoff} instruction inside a \TeX\ \enquote{group}\textemdash something that's delimited by a pair of curly braces or by \cmmd{bgroup} and \cmmd{egroup} statements\textemdash will \emph{not} switch \pkg{selnolig}'s macros back on after the end of the \TeX\ group is reached. This is because 	\pkg{selnolig}'s main lua function is implemented as a callback routine. Adding this lua function to and removing it from the callback list, which is what  \cmmd{selnoligon} and \cmmd{selnoligoff} do, is not affected by \TeX\ groups. That's why it's necessary to issue a \cmmd{selnoligon} command to switch  \pkg{selnolig}'s macros back on.


\subsection{Lists of words fitting German and English language non-ligation patterns}

Extensive lists of German and English language words for which one or more ligatures should be suppressed are provided in the files \pkg{selnolig-german-wordlist.tex} and \pkg{selnolig-english-wordlist.tex}.\footnote{I started the list of German language words with the examples provided by the \pkg{rmligs} script, but have come up with quite a few more words since then.} Obviously, I can't and won't make a claim that either of these lists is complete. Suggestions for additional words are always welcome.

The files \pkg{selnolig-german-test.tex} and \pkg{selnolig-english-text.tex} are \enquote{driver programs} that load the \pkg{selnolig} package and then run it on the respective lists of German- and English-language words. To compile the driver programs, be sure to use \LuaLaTeX because they make use of the \pkg{selnolig} package.




\appendix
\selnoligoff

\clubpenalty100
\widowpenalty100
\small

\section[The package's main style file: selnolig.sty]
{The package's main style file: \pkg{selnolig.sty}}

\VerbatimInput{selnolig.sty}

\clearpage
\section[The package's lua code: selnolig.lua]{The package's lua code: \pkg{selnolig.lua}}
\label{sec:luacode}

\VerbatimInput{selnolig.lua}

\clearpage
\newgeometry{hmargin=1in}

\section[English-language ligature suppression patterns: selnolig-english-patterns.sty]{English-language ligature suppression patterns: \\ 
\pkg{selnolig-english-patterns.sty}}
\label{sec:eng-listing}

\begin{multicols}{2}
\VerbatimInput{selnolig-english-patterns.sty}
\end{multicols}

\clearpage
\section[German-language ligature suppression patterns:
selnolig-german-patterns.sty]{German-language ligature suppression patterns: \\ 
\pkg{selnolig-german-patterns.sty}}
\label{sec:germ-listing}


Introductory note: To accommodate the practice of Swiss-German writers of not using the \enquote{ß} character (and using \enquote{ss} in its place), all search-and-insert strings that contain an \enquote{ß} character are duplicated with equivalent search-and-insert strings containing \enquote{ss}.

\bigskip

\begin{multicols}{2}
\VerbatimInput{selnolig-german-patterns.sty}
\end{multicols}

\clearpage
\section[Reporting bugs and other issues with the selnolig package: A suggested template]{Reporting bugs and other issues with the \pkg{selnolig} package:\\A suggested template} \label{sec:template}

\VerbatimInput{selnolig-bugreport.tex}


\end{document}
